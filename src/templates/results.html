{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
{% if error %}
<section class="error-section">
    <div class="error-box">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h2>–û—à–∏–±–∫–∞</h2>
        <p>{{ error }}</p>
        <a href="/" class="btn btn-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥</a>
    </div>
</section>
{% else %}
<header class="results-header">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</h1>
</header>

<section class="stats-grid" aria-label="–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏">
    <article class="stat-card" aria-label="–í—Å–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π">
        <div class="stat-icon" aria-hidden="true">üìù</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_comparisons }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
        </div>
    </article>
    <article class="stat-card stat-primary" aria-label="–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞">
        <div class="stat-icon" aria-hidden="true">üéØ</div>
        <div class="stat-content">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_score) }}%</div>
            <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
        </div>
    </article>
    <article class="stat-card stat-success" aria-label="–£—Å–ø–µ—à–Ω–æ">
        <div class="stat-icon" aria-hidden="true">‚úÖ</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.passed }}</div>
            <div class="stat-label">–£—Å–ø–µ—à–Ω–æ (‚â•70%)</div>
        </div>
    </article>
    <article class="stat-card stat-danger" aria-label="–ù–µ—É–¥–∞—á–Ω–æ">
        <div class="stat-icon" aria-hidden="true">‚ùå</div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.failed }}</div>
            <div class="stat-label">–ù–µ—É–¥–∞—á–Ω–æ (&lt;70%)</div>
        </div>
    </article>
</section>

<section class="charts-section" aria-label="–î–∏–∞–≥—Ä–∞–º–º—ã">
    <article class="chart-card">
        <h3>–û—Ü–µ–Ω–∫–∏ –ø–æ —Ñ–∞–π–ª–∞–º</h3>
        <canvas id="scoresChart" role="img" aria-label="–°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –æ—Ü–µ–Ω–æ–∫"></canvas>
    </article>
    <article class="chart-card">
        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</h3>
        <canvas id="distributionChart" role="img" aria-label="–ö–æ–ª—å—Ü–µ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"></canvas>
    </article>
</section>

<section class="results-table-section" aria-label="–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã">
    <div class="section-header">
        <h2>–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <a href="/export/{{ session_id }}" class="btn btn-outline btn-sm">
            –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </a>
    </div>
    <div class="table-responsive">
        <table class="results-table">
            <thead>
                <tr>
                    <th scope="col">‚Ññ</th>
                    <th scope="col">–≠—Ç–∞–ª–æ–Ω (PUML)</th>
                    <th scope="col">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π JSON</th>
                    <th scope="col">–û—Ü–µ–Ω–∫–∞</th>
                    <th scope="col">–ö–ª–∞—Å—Å—ã F1</th>
                    <th scope="col">–ê—Ç—Ä–∏–±—É—Ç—ã F1</th>
                    <th scope="col">–î–µ—Ç–∞–ª–∏</th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td class="filename">{{ result.etalon_file }}</td>
                    <td class="filename">{{ result.student_file }}</td>
                    <td>
                        {% if result.error and result.score == 0 %}
                        <span class="badge badge-error">–û—à–∏–±–∫–∞</span>
                        {% else %}
                        <span
                            class="score-badge score-{{ 'excellent' if result.score >= 90 else 'good' if result.score >= 70 else 'poor' }}">
                            {{ "%.1f"|format(result.score) }}%
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if result.classes %}
                        <span class="metric">{{ "%.3f"|format(result.classes.f1) }}</span>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if result.attributes %}
                        <span class="metric">{{ "%.3f"|format(result.attributes.f1) }}</span>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if result.error %}
                        <span class="error-text">{{ result.error }}</span>
                        {% else %}
                        <button type="button" class="btn btn-sm btn-outline details-toggle"
                            data-details-target="details-{{ loop.index0 }}" aria-expanded="false">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% if not result.error %}
                <tr id="details-{{ loop.index0 }}" class="details-row is-hidden" aria-live="polite">
                    <td colspan="7">
                        <div class="details-content">
                            <div class="details-grid">
                                <section class="detail-section" aria-label="–ö–ª–∞—Å—Å—ã">
                                    <h4>–ö–ª–∞—Å—Å—ã</h4>
                                    <ul class="metrics-list">
                                        <li><strong>Precision:</strong> {{ "%.3f"|format(result.classes.precision) }}
                                        </li>
                                        <li><strong>Recall:</strong> {{ "%.3f"|format(result.classes.recall) }}</li>
                                        <li><strong>F1:</strong> {{ "%.3f"|format(result.classes.f1) }}</li>
                                        <li><strong>–≠—Ç–∞–ª–æ–Ω:</strong> {{ result.classes.etalon_count }} –∫–ª–∞—Å—Å–æ–≤</li>
                                        <li><strong>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π:</strong> {{ result.classes.student_count }} –∫–ª–∞—Å—Å–æ–≤
                                        </li>
                                        <li><strong>–°–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> {{ result.classes.matched }}</li>
                                    </ul>
                                </section>
                                <section class="detail-section" aria-label="–ê—Ç—Ä–∏–±—É—Ç—ã">
                                    <h4>–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
                                    <ul class="metrics-list">
                                        <li><strong>Precision:</strong> {{ "%.3f"|format(result.attributes.precision) }}
                                        </li>
                                        <li><strong>Recall:</strong> {{ "%.3f"|format(result.attributes.recall) }}</li>
                                        <li><strong>F1:</strong> {{ "%.3f"|format(result.attributes.f1) }}</li>
                                        <li><strong>–≠—Ç–∞–ª–æ–Ω:</strong> {{ result.attributes.etalon_count }} –∞—Ç—Ä–∏–±—É—Ç–æ–≤</li>
                                        <li><strong>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π:</strong> {{ result.attributes.student_count }}
                                            –∞—Ç—Ä–∏–±—É—Ç–æ–≤</li>
                                        <li><strong>–°–æ–≤–ø–∞–¥–µ–Ω–∏–π:</strong> {{ result.attributes.matched }}</li>
                                    </ul>
                                </section>
                            </div>
                            {% set diff = result.diff if result.diff is defined else None %}
                            {% if diff and (diff.classes.missing or diff.classes.extra or diff.attributes) %}
                            <div class="diff-section" aria-label="–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è">
                                <h4>–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h4>
                                <div class="diff-grid">
                                    <article class="diff-card" aria-label="–†–∞–∑–ª–∏—á–∏—è –∫–ª–∞—Å—Å–æ–≤">
                                        <h5>–ö–ª–∞—Å—Å—ã</h5>
                                        {% if not diff.classes.missing and not diff.classes.extra %}
                                        <p class="diff-empty">–í—Å–µ –∫–ª–∞—Å—Å—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç.</p>
                                        {% else %}
                                        {% if diff.classes.missing %}
                                        <div class="diff-list-title">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ JSON</div>
                                        <ul class="diff-list">
                                            {% for name in diff.classes.missing %}
                                            <li class="diff-item diff-missing">{{ name }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                        {% if diff.classes.extra %}
                                        <div class="diff-list-title">–õ–∏—à–Ω–∏–µ –≤ JSON</div>
                                        <ul class="diff-list">
                                            {% for name in diff.classes.extra %}
                                            <li class="diff-item diff-extra">{{ name }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                        {% endif %}
                                    </article>
                                    {% if diff.attributes %}
                                    <article class="diff-card diff-card-wide" aria-label="–†–∞–∑–ª–∏—á–∏—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤">
                                        <h5>–ê—Ç—Ä–∏–±—É—Ç—ã</h5>
                                        <div class="diff-attributes">
                                            {% for entry in diff.attributes %}
                                            <div class="diff-attribute-group">
                                                <div class="diff-attribute-title">
                                                    {{ entry.etalon_class or '‚Äî' }} ‚Üí {{ entry.student_class or '‚Äî' }}
                                                </div>
                                                <div class="diff-attribute-columns">
                                                    <div>
                                                        <div class="diff-list-title">–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>
                                                        {% if entry.missing %}
                                                        <ul class="diff-list">
                                                            {% for item in entry.missing %}
                                                            <li class="diff-item diff-missing">{{ item }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                        {% else %}
                                                        <p class="diff-empty">‚Äî</p>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="diff-list-title">–õ–∏—à–Ω–∏–µ</div>
                                                        {% if entry.extra %}
                                                        <ul class="diff-list">
                                                            {% for item in entry.extra %}
                                                            <li class="diff-item diff-extra">{{ item }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                        {% else %}
                                                        <p class="diff-empty">‚Äî</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </article>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if not error %}
<script id="comparison-chart-data" type="application/json">
    {{ {
        'labels': chart_labels,
        'scores': chart_scores
    } | tojson }}
</script>
<script id="results-data" type="application/json">
    {{ results | tojson }}
</script>
{% endif %}
{% endblock %}